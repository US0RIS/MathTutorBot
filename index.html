<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>8th Grade Math Tutor 🤖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#f7f8fc;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --brand:#111827;
      --accent:#0ea5e9;
      --border:#e5e7eb;
      --error:#dc2626;
      --ok:#059669;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:860px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(22px,4vw,34px);margin:8px 0 18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 6px rgba(0,0,0,.04);padding:18px}
    .header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .controls{display:flex;gap:10px}
    button{
      cursor:pointer;border:0;background:#111827;color:#fff;padding:8px 14px;border-radius:10px;
      font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.12)
    }
    button.secondary{background:#e5e7eb;color:#111827}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:14px;margin:8px 0 0}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    input[type="text"],textarea{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;font:inherit;background:#fff
    }
    .chat{min-height:260px;margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .msg{margin:8px 0}
    .msg b{color:var(--brand)}
    .msg.error{color:var(--error)}
    .msg.ok{color:var(--ok)}
    .msg .bubble{display:inline-block;padding:8px 10px;border-radius:10px;background:#f8fafc}
    .msg.me .bubble{background:#eef6ff}
    .foot{display:flex;gap:10px;margin-top:12px}
    .note{font-size:12px;color:var(--muted);margin-top:6px}
    .mode{font-variant:all-small-caps;font-weight:700;color:var(--muted)}
    .lock{display:flex;gap:8px;align-items:center;margin-top:8px}
    .pill{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fafafa;color:#334155}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>8th Grade Math Tutor 🤖</h1>
      <div class="controls">
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="clearBtn" class="secondary">Clear history</button>
      </div>
    </div>

    <!-- Access code area -->
    <div class="card">
      <div class="row">
        <input id="codeInput" type="text" placeholder="Enter access code…" />
        <button id="unlockBtn">Unlock</button>
        <button id="lockBtn" class="secondary">Lock</button>
      </div>
      <div class="lock">
        <span id="modeBadge" class="pill">Steps-only mode. Enter code to unlock answers.</span>
      </div>
    </div>

    <!-- Chat -->
    <div class="card" style="margin-top:16px">
      <div id="intro" class="hint">👋 Ask a math question and I’ll guide you through the steps. I won’t give the final numeric answer.</div>
      <div id="chat" class="chat"></div>

      <div class="foot">
        <input id="input" type="text" placeholder="Ask a math question… (press Enter)" />
        <button id="sendBtn">Send</button>
      </div>
      <div class="note">
        The bot explains steps and encourages thinking — no final answers unless unlocked.<br/>
        <span class="pill" id="storageInfo">(stored turns: 0) • <span class="mode" id="modeText">Mode: steps</span></span>
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG (change this!) ========= */
// Put your live Replit URL (while server is running) + /ask
// e.g. "https://math-backend.us0ris.repl.co/ask" or "...replit.dev/ask"
const BACKEND_URL = "https://e1daa5d0-10d2-48ff-9214-1495a9b30b37-00-3fsa6b19pb26o.riker.replit.dev/ask";

// Access code for Answer mode (change to whatever you want)
const ACCESS_CODE = "auRPpLZi7t5FKRPVQjhUem1ET";

/* ========= State ========= */
const elChat = document.getElementById("chat");
const elInput = document.getElementById("input");
const elSend = document.getElementById("sendBtn");
const elReset = document.getElementById("resetBtn");
const elClear = document.getElementById("clearBtn");
const elModeText = document.getElementById("modeText");
const elBadge = document.getElementById("modeBadge");
const elCode = document.getElementById("codeInput");
const elUnlock = document.getElementById("unlockBtn");
const elLock = document.getElementById("lockBtn");
const elStorageInfo = document.getElementById("storageInfo");

let chatHistory = loadHistory();          // [{role:"user"|"assistant", content:"..."}]
let mode = loadMode();                    // "steps" | "answers"
renderHistory();
updateModeUI();

/* ========= Helpers ========= */
function saveHistory(){ localStorage.setItem("mt_history", JSON.stringify(chatHistory)); updateStorageInfo(); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem("mt_history")) || []; } catch{ return []; } }
function clearHistory(){ chatHistory = []; saveHistory(); elChat.innerHTML = ""; updateStorageInfo(); }

function saveMode(m){ mode = m; localStorage.setItem("mt_mode", mode); updateModeUI(); }
function loadMode(){ return localStorage.getItem("mt_mode") || "steps"; }

function updateModeUI(){
  elModeText.textContent = "Mode: " + mode;
  elBadge.textContent = (mode === "answers")
    ? "Answer mode unlocked for this tab. I can include final numeric answers now."
    : "Steps-only mode. Enter code to unlock answers.";
}
function updateStorageInfo(){
  elStorageInfo.innerHTML = `(stored turns: ${chatHistory.length}) • <span class="mode" id="modeText">Mode: ${mode}</span>`;
}

function append(role, who, text, extraClass=""){
  const id = Math.random().toString(36).slice(2,9);
  const div = document.createElement("div");
  div.className = `msg ${role==="me"?"me":""} ${extraClass}`;
  const html = marked.parse(preClean(text));
  div.innerHTML = `<b>${who}:</b> <div class="bubble" id="${id}">${html}</div>`;
  elChat.appendChild(div);
  elChat.scrollTop = elChat.scrollHeight;
  return id;
}

function preClean(s){
  // remove any stray [OUT] markers and convert ~~strike~~ to plain
  return s.replace(/\[\s*OUT\s*]/gi,"").replace(/~~([^~]+)~~/g,"$1");
}

function smallCleanText(markdownHTML){
  // strip HTML to store plain text for the model history
  const tmp = document.createElement("div");
  tmp.innerHTML = markdownHTML;
  return (tmp.textContent || tmp.innerText || "").trim();
}

/* ========= Render existing history ========= */
function renderHistory(){
  elChat.innerHTML = "";
  for(const m of chatHistory){
    if(m.role === "user"){
      append("me","You", m.content);
    }else{
      const html = marked.parse(preClean(m.content));
      const id = append("b", "TutorBot", m.content);
      // ensure stored assistant text stays as raw markdown, not HTML
      document.getElementById(id).innerHTML = html;
    }
  }
  updateStorageInfo();
}

/* ========= Send flow ========= */
async function send(){
  const message = elInput.value.trim();
  if(!message) return;

  append("me","You", message);
  elInput.value = "";

  // keep a short context (last ~12 turns total)
  const shortHistory = chatHistory.slice(-12);

  // send
  try{
    const r = await fetch(BACKEND_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        message,
        history: shortHistory,
        mode
      })
    });

    if(!r.ok){
      const t = await r.text();
      append("b","TutorBot", `⚠️ Server error (${r.status}).`, "error");
      console.error("Server error:", r.status, t);
      return;
    }

    const data = await r.json();
    const reply = (data.reply || "").trim();

    if(reply && reply !== "."){
      const id = append("b","TutorBot", reply);
      const cleanMem = smallCleanText(marked.parse(preClean(reply)));

      // Save into memory
      chatHistory.push({ role:"user", content: message });
      chatHistory.push({ role:"assistant", content: cleanMem });
      saveHistory();

      // ensure UI shows markdown-rendered reply
      document.getElementById(id).innerHTML = marked.parse(preClean(reply));
    }else{
      append("b","TutorBot","⚠️ The tutor bot didn’t give a proper response. Please try again.","error");
    }
  }catch(err){
    console.error(err);
    append("b","TutorBot","⚠️ Couldn’t reach the tutor server. Check your connection and try again.","error");
  }
}

/* ========= Events ========= */
elSend.onclick = send;
elInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });

elReset.onclick = () => {
  clearHistory();
  append("b","TutorBot","Memory cleared for this tab. Ask me a question!");
};
elClear.onclick = () => {
  clearHistory();
};

elUnlock.onclick = () => {
  const code = elCode.value.trim();
  if(code && code === ACCESS_CODE){
    saveMode("answers");
    append("b","TutorBot","Answer mode unlocked for this tab. I can include final numeric answers now.","ok");
  }else{
    append("b","TutorBot","❌ Incorrect code. Still in steps-only mode.","error");
  }
};
elLock.onclick = () => {
  saveMode("steps");
  append("b","TutorBot","Answer mode locked. I will not reveal the final numeric answer.","ok");
};
</script>
</body>
</html>
