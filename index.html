<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>8th Grade Math Helper ðŸ¤–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fc; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#111827; --accent:#2563eb; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 900px; margin: 36px auto; padding: 0 16px; }
    h1 { font-size: clamp(24px, 4vw, 32px); margin: 0 0 16px; display:flex; align-items:center; gap:10px;}
    .bar { display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px; gap:10px; }
    .btns { display:flex; gap:8px; }
    .bar button { padding:8px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
    .card { background: var(--card); border:1px solid #e5e7eb; border-radius: 14px; padding: 18px; }

    #gate { background: var(--card); border:1px solid #e5e7eb; border-radius: 14px; padding: 18px; margin-bottom:16px; }
    #gate .row { display:flex; gap:8px; margin-top: 8px; }
    #gate input { flex: 1; padding: 10px 12px; border:1px solid #d1d5db; border-radius: 10px; font-size: 16px; outline: none; }
    #gate button { padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; background:#fff; cursor:pointer; }
    #gate .note { color: var(--muted); font-size: 14px; }

    #chat { min-height: 340px; max-height: 60vh; overflow:auto; line-height:1.6; }
    .msg { margin: 10px 0; }
    .u  { color: var(--accent); font-weight: 600; }
    .b  { color: #059669; font-weight: 600; }
    .system { color: var(--muted); font-style: italic; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    input[type="text"] { flex: 1; padding: 12px 14px; border:1px solid #d1d5db; border-radius: 10px; font-size: 16px; outline: none; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }
    button.send { padding: 12px 16px; border: none; border-radius: 10px; background: var(--primary); color: white; font-size: 16px; cursor: pointer; }
    button.send[disabled] { opacity:.7; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: 14px; margin-top: 8px; }
    .typing { color: var(--muted); font-style: italic; }
    .error { color: #b91c1c; }
    .tiny { color: var(--muted); font-size: 12px; }

    /* Kill any strikethrough coming from models */
    del, s, strike { text-decoration: none !important; }
    [style*="line-through"] { text-decoration: none !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>8th Grade Math Helper ðŸ¤–</h1>
      <div class="btns">
        <button id="resetBtn">Reset</button>
        <button id="clearBtn">Clear history</button>
      </div>
    </div>

    <!-- ðŸ”’ Unlock Gate -->
    <div id="gate">
      <strong>ðŸ”’ Restricted area</strong>
      <div class="note">
        Enter access code to unlock <em>Answer mode</em> (gives final answers). Leave locked for steps-only mode.
      </div>
      <div class="row">
        <input id="codeInput" type="password" placeholder="Enter access codeâ€¦" autocomplete="off" />
        <button id="unlockBtn">Unlock</button>
        <button id="lockBtn">Lock</button>
      </div>
      <div id="gateMsg" class="note"></div>
    </div>

    <div class="card">
      <div id="chat">
        <div class="msg system">ðŸ‘‹ Ask a math question and Iâ€™ll guide you through the steps. I wonâ€™t give the final numeric answer unless unlocked.</div>
      </div>

      <div class="row">
        <input id="userInput" type="text" placeholder="Ask a math questionâ€¦ (press Enter)" autocomplete="off" />
        <button id="sendBtn" class="send">Send</button>
      </div>
      <div class="hint">The bot explains steps and encourages thinking â€” no final answers unless unlocked.</div>
      <div id="debug" class="tiny"></div>
    </div>
  </div>

  <script>
    // ðŸ”§ Set your backend /ask URL
    const BACKEND_URL = "https://YOUR-REPLIT-URL/ask";

    // ðŸ”‘ Change this!
    const SECRET_CODE = "unlock123";

    // Persist unlock state in sessionStorage (clears on tab close)
    const UNLOCK_KEY = "tutor_unlock_v1";
    let unlocked = sessionStorage.getItem(UNLOCK_KEY) === "true";

    // History in localStorage
    const STORAGE_KEY = "tutor_history_v5";

    const chat    = document.getElementById('chat');
    const input   = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn= document.getElementById('resetBtn');
    const clearBtn= document.getElementById('clearBtn');
    const debugEl = document.getElementById('debug');

    const codeInput = document.getElementById('codeInput');
    const unlockBtn = document.getElementById('unlockBtn');
    const lockBtn   = document.getElementById('lockBtn');
    const gateMsg   = document.getElementById('gateMsg');

    // UI gate status
    function refreshGateUI() {
      gateMsg.textContent = unlocked
        ? "âœ… Answer mode is unlocked for this tab."
        : "ðŸ”’ Steps-only mode. Enter code to unlock answers.";
    }
    refreshGateUI();

    // Unlock / lock handlers
    unlockBtn.onclick = () => {
      const entered = (codeInput.value || "").trim();
      if (entered === SECRET_CODE) {
        unlocked = true;
        sessionStorage.setItem(UNLOCK_KEY, "true");
        refreshGateUI();
        append('b', 'TutorBot', "Answer mode unlocked for this tab. I can include final numeric answers now.");
      } else {
        gateMsg.textContent = "âŒ Wrong code.";
      }
      codeInput.value = "";
    };

    lockBtn.onclick = () => {
      unlocked = false;
      sessionStorage.removeItem(UNLOCK_KEY);
      refreshGateUI();
      append('b', 'TutorBot', "Locked back to steps-only mode. I wonâ€™t give final answers.");
    };

    // -------- History --------
    let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

    function renderHistory() {
      chat.innerHTML = `<div class="msg system">ðŸ‘‹ Ask a math question and Iâ€™ll guide you through the steps. I wonâ€™t give the final numeric answer unless unlocked.</div>`;
      for (const m of chatHistory) {
        if (m.role === "user") append("u", "You", m.content);
        if (m.role === "assistant") append("b", "TutorBot", m.content);
      }
      debugEl.textContent = `(context turns stored: ${chatHistory.length}) â€¢ Mode: ${unlocked ? "answers" : "steps"}`;
    }
    renderHistory();

    function saveHistory() {
      chatHistory = chatHistory.slice(-12);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
      debugEl.textContent = `(context turns stored: ${chatHistory.length}) â€¢ Mode: ${unlocked ? "answers" : "steps"}`;
    }

    resetBtn.addEventListener('click', renderHistory);
    clearBtn.addEventListener('click', () => {
      chatHistory = [];
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    });

    // -------- Cleaning helpers (nuke [OUT] and strikethrough) --------
    function preClean(text) {
      if (!text) return "";
      let t = text.normalize("NFKC").replace(/[\u200B-\u200D\uFEFF]/g, "");
      t = t
        .replace(/\[\s*OUT\s*]/gi, "")
        .replace(/&#91;\s*OUT\s*&#93;/gi, "")
        .replace(/\[\s*O\s*U\s*T\s*]/gi, "")
        .replace(/~~([^~]+)~~/g, "$1");
      return t.trim();
    }

    function renderMarkdownSafe(text) {
      const html = marked.parse(preClean(text));
      const tmp = document.createElement("div");
      tmp.innerHTML = html;

      const walker = document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT);
      const unwrap = [];
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.nodeType === Node.TEXT_NODE) {
          node.nodeValue = node.nodeValue
            .replace(/\[\s*OUT\s*]/gi, "")
            .replace(/&#91;\s*OUT\s*&#93;/gi, "");
        } else {
          const el = node;
          const tag = el.tagName.toLowerCase();
          if (tag === "s" || tag === "strike" || tag === "del") unwrap.push(el);
          const s1 = (el.style && el.style.textDecoration || "").toLowerCase();
          if (s1.includes("line-through")) el.style.textDecoration = "none";
          const sAttr = (el.getAttribute("style") || "").toLowerCase();
          if (sAttr.includes("line-through")) {
            el.setAttribute("style", sAttr.replace(/text-decoration\s*:\s*line-through;?/g, "text-decoration:none;"));
          }
        }
      }
      for (const el of unwrap) {
        while (el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
        el.parentNode.removeChild(el);
      }
      return tmp.innerHTML;
    }

    function append(labelClass, labelText, text, extraClass="") {
      const div = document.createElement('div');
      div.className = `msg ${extraClass}`;
      if (labelText === "TutorBot") {
        div.innerHTML = `<span class="${labelClass}">${labelText}:</span> ${renderMarkdownSafe(text)}`;
      } else {
        div.innerHTML = `<span class="${labelClass}">${labelText}:</span> ${escapeHtml(text)}`;
      }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function appendRaw(html, extraClass="") {
      const div = document.createElement('div');
      div.className = `msg ${extraClass}`;
      div.innerHTML = html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function friendlyError(status, bodyText) {
      const t = (bodyText || "").toLowerCase();
      if (status === 503 || t.includes("busy")) return "All free providers are busy right now. Try again in a minute.";
      if (status === 429 || t.includes("rate limit")) return "The free service is temporarily rate-limited. Try again shortly.";
      if (status === 404 && (t.includes("no endpoints") || t.includes("free model")))
        return "That free model isnâ€™t available right now â€” trying other options.";
      if (t.includes("not allowed by cors")) return "This page isnâ€™t allowed to reach the tutor server (CORS). Tell the site owner.";
      return "Server error. Please try again soon.";
    }

    // -------- Chat send --------
    async function send() {
      const message = input.value.trim();
      if (!message) return;

      append('u', 'You', message);
      input.value = "";
      sendBtn.disabled = true;
      const typingId = `typing-${Date.now()}`;
      appendRaw(`<span id="${typingId}" class="typing">TutorBot is thinkingâ€¦</span>`);

      try {
        const r = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            history: chatHistory,
            mode: unlocked ? "answers" : "steps"
          })
        });

        const raw = await r.text();
        let data = null;
        try { data = JSON.parse(raw); } catch {}

        const t = document.getElementById(typingId);
        if (t) t.remove();

        if (r.ok && data && data.reply) {
          const reply = data.reply || "";
          append('b', 'TutorBot', reply);
          // store a plain-text version for memory
          const tmp = document.createElement("div");
          tmp.innerHTML = marked.parse(preClean(reply));
          const memText = tmp.textContent || tmp.innerText || "";
          chatHistory.push({ role: "user", content: message });
          chatHistory.push({ role: "assistant", content: memText });
          saveHistory();
        } else {
          const msg = friendlyError(r.status, (data && (data.error || data.detail)) || raw);
          append('b', 'TutorBot', `âš ï¸ ${msg}`, 'error');
        }
      } catch (err) {
        const t = document.getElementById(typingId);
        if (t) t.remove();
        append('b', 'TutorBot', "âš ï¸ Couldnâ€™t reach the tutor server. Check your connection and try again.", 'error');
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

    // Optional one-time clear via hash
    if (location.hash === "#clear") {
      chatHistory = [];
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      history.replaceState(null, "", location.pathname);
    }
  </script>
</body>
</html>
