<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>8th Grade Math Tutor 🤖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#f7f8fc;--panel:#ffffff;--text:#0f172a;--muted:#475569;
      --brand:#111827;--border:#e5e7eb;--error:#dc2626;--ok:#059669
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:860px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(22px,4vw,34px);margin:8px 0 18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 6px rgba(0,0,0,.04);padding:18px}
    .header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .controls{display:flex;gap:10px}
    button{cursor:pointer;border:0;background:#111827;color:#fff;padding:8px 14px;border-radius:10px;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.12)}
    button.secondary{background:#e5e7eb;color:#111827}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:14px;margin:8px 0 0}
    .row{display:flex;gap:10px}.row>*{flex:1}
    input[type="text"]{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;font:inherit;background:#fff}
    .chat{min-height:260px;margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .msg{margin:8px 0}.msg b{color:var(--brand)}.msg.error{color:var(--error)}.msg.ok{color:var(--ok)}
    .msg .bubble{display:inline-block;padding:8px 10px;border-radius:10px;background:#f8fafc}
    .msg.me .bubble{background:#eef6ff}
    .foot{display:flex;gap:10px;margin-top:12px}
    .note{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fafafa;color:#334155}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>8th Grade Math Tutor 🤖</h1>
      <div class="controls">
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="clearBtn" class="secondary">Clear history</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <input id="codeInput" type="text" placeholder="Enter access code…" />
        <button id="unlockBtn">Unlock</button>
        <button id="lockBtn" class="secondary">Lock</button>
      </div>
      <div class="hint"><span id="modeBadge" class="pill">Steps-only mode. Enter code to unlock answers.</span></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="intro" class="hint">👋 Ask a math question and I’ll guide you through the steps. I won’t give the final numeric answer.</div>
      <div id="chat" class="chat"></div>

      <div class="foot">
        <input id="input" type="text" placeholder="Ask a math question… (press Enter)" />
        <button id="sendBtn">Send</button>
      </div>
      <div class="note">
        The bot explains steps and encourages thinking — no final answers.<br/>
        <span class="pill" id="storageInfo">(stored turns: 0) • Mode: <span id="modeText">steps</span></span>
      </div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const BACKEND_URL = "https://e1daa5d0-10d2-48ff-9214-1495a9b30b37-00-3fsa6b19pb26o.riker.replit.dev/ask"; // <= your /ask URL
const ACCESS_CODE = "auRPpLZi7t5FKRPVQjhUem1ET";

/* ========= State ========= */
const elChat = document.getElementById("chat");
const elInput = document.getElementById("input");
const elSend = document.getElementById("sendBtn");
const elReset = document.getElementById("resetBtn");
const elClear = document.getElementById("clearBtn");
const elModeText = document.getElementById("modeText");
const elBadge = document.getElementById("modeBadge");
const elCode = document.getElementById("codeInput");
const elUnlock = document.getElementById("unlockBtn");
const elLock = document.getElementById("lockBtn");
const elStorageInfo = document.getElementById("storageInfo");

let chatHistory = loadHistory();       // [{role:"user"|"assistant", content:"markdown"}]
let mode = loadMode();                 // "steps" | "answers"
renderHistory();
updateModeUI();

/* ========= Helpers ========= */
function saveHistory(){ localStorage.setItem("mt_history", JSON.stringify(chatHistory)); updateStorageInfo(); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem("mt_history")) || []; } catch{ return []; } }
function clearHistory(){ chatHistory = []; saveHistory(); elChat.innerHTML = ""; updateStorageInfo(); }

function saveMode(m){ mode = m; localStorage.setItem("mt_mode", mode); updateModeUI(); }
function loadMode(){ return localStorage.getItem("mt_mode") || "steps"; }
function updateModeUI(){
  elModeText.textContent = mode;
  elBadge.textContent = (mode === "answers")
    ? "Answer mode unlocked for this tab. I can include final numeric answers now."
    : "Steps-only mode. Enter code to unlock answers.";
}
function updateStorageInfo(){
  elStorageInfo.innerHTML = `(stored turns: ${chatHistory.length}) • Mode: <span id="modeText">${mode}</span>`;
}
function cleanForDisplay(s){
  return s.replace(/\[\s*OUT\s*]/gi,"").replace(/~~([^~]+)~~/g,"$1");
}
function append(role, who, text, extraClass=""){
  const id = Math.random().toString(36).slice(2,9);
  const div = document.createElement("div");
  div.className = `msg ${role==="me"?"me":""} ${extraClass}`;
  const html = marked.parse(cleanForDisplay(text));
  div.innerHTML = `<b>${who}:</b> <div class="bubble" id="${id}">${html}</div>`;
  elChat.appendChild(div);
  elChat.scrollTop = elChat.scrollHeight;
  return id;
}
function renderHistory(){
  elChat.innerHTML = "";
  for(const m of chatHistory){
    if(m.role === "user") append("me","You", m.content);
    else {
      const id = append("b","TutorBot", m.content);
      document.getElementById(id).innerHTML = marked.parse(cleanForDisplay(m.content));
    }
  }
  updateStorageInfo();
}

/* ========= Send ========= */
async function send(){
  const message = elInput.value.trim();
  if(!message) return;

  append("me","You", message);
  elInput.value = "";

  const shortHistory = chatHistory.slice(-24); // bigger window

  try{
    const r = await fetch(BACKEND_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message, history: shortHistory, mode })
    });

    if(!r.ok){
      const t = await r.text();
      append("b","TutorBot", `⚠️ Server error (${r.status}).`, "error");
      console.error("Server error:", r.status, t);
      return;
    }

    const data = await r.json();
    const reply = (data.reply || "").trim();

    if(reply && reply !== "."){
      const id = append("b","TutorBot", reply);
      // store RAW markdown reply (better for context)
      chatHistory.push({ role:"user", content: message });
      chatHistory.push({ role:"assistant", content: reply });
      saveHistory();
      document.getElementById(id).innerHTML = marked.parse(cleanForDisplay(reply));
    }else{
      append("b","TutorBot","⚠️ The tutor bot didn’t give a proper response. Please try again.","error");
    }
  }catch(err){
    console.error(err);
    append("b","TutorBot","⚠️ Couldn’t reach the tutor server. Check your connection and try again.","error");
  }
}

/* ========= Events ========= */
elSend.onclick = send;
elInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });

elReset.onclick = () => {
  clearHistory();
  append("b","TutorBot","Memory cleared for this tab. Ask me a question!");
};
elClear.onclick = clearHistory;

elUnlock.onclick = () => {
  const code = elCode.value.trim();
  if(code && code === ACCESS_CODE){
    saveMode("answers");
    append("b","TutorBot","Answer mode unlocked for this tab. I can include final numeric answers now and help with other subjects.","ok");
  }else{
    append("b","TutorBot","❌ Incorrect code.","error");
  }
};
elLock.onclick = () => {
  saveMode("steps");
  append("b","TutorBot","Answer mode locked. I will not reveal the final numeric answer.","ok");
};
</script>
</body>
</html>
